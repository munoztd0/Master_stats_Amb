---
title: "ANALYSIS REPORT"
author: "Ambroise"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:  
    includes:
    code_folding: "hide"
    toc: true
    toc_float: false
    number_sections: false
  pdf_document:
    extra_dependencies: ["float"]
repro:
  data:
    data_ambroise_full: Enquete_Ambroise.sav
    
  packages: [ aaronpeikert/repro@devel, crsh/papaja@devel, tinylabels, apaTables, haven, ggplot2,  tidyverse, gtsummary, car, GGally, MASS, matrixStats, rcompanion, moments, utils, sjPlot, interactions, kableExtra]
  scripts: clean.R
---

### Setup {-}
  
```{r setup, results='hide', message=FALSE, warning=FALSE}

library(repro)
# load packages from yaml header
automate_load_packages()
# include external scripts
automate_load_scripts()

# load data
data_ambroise_full  <- automate_load_data(data_ambroise_full, read_sav)



sessio = sessionInfo(); #opts_chunk$set(echo = F, message=F, warning=F) # set echo F for all

  
```

This file was automatically created via `the Repro package (version 0.1.0)` using  `r sessio$R.version$version.string`




```{r options, results='hide', message=FALSE, warning=FALSE}
options(scipen = 666, warn=-1, contrasts=c("contr.sum","contr.poly"), knitr.kable.NA = '')  #remove scientific notation # remove warnings #set contrasts to sum ! 
set.seed(666) #set random seed

# panderOptions('knitr.auto.asis', FALSE) #remove auto styling

# Look at R/clean.R (listed in the YAML) which does all the preprocessing for more info


# If you are unsure weather or not you have `git` `make` & `docker`.
# check_git()
# check_make()
# check_docker()
```




```{r clean, include=FALSE,  cache = TRUE}
# this chunk runs clean.R (listed in the YAML) which does all the preprocessing
```

### Introduction
Blabla

#### Demographics
```{r demographics}
base[c("Age", "Gender", "Profession")] %>%  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} / {N} ({p}%)"),)  %>% modify_caption("**Table 1. Demographics **") %>%
  bold_labels()
```
$~$
$~$

### Statistics

$~$
$~$

#####  Correlation 
```{r clean up, echo=FALSE, message=FALSE, warning=FALSE}
base_clean$Gender = recode_factor(base_clean$Gender, "Autre/NA" = NA_character_)

ggpubr::ggscatter(base_clean, x = "negatif_cilmat", y = "positive_climate", position = position_jitter(w = 0.1, h = 0.1),
                  color = "black", shape = 21, size = 3, # Points color, shape and size
                  add = "reg.line",  # Add regressin line
                  add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                  conf.int = TRUE, # Add confidence interval
                  cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
                  cor.coeff.args = list(method = "pearson", label.x = 6, label.sep = "\n")
)
```

$~$
$~$

#### Price
```{r lm Price}
base_price = base_clean #no huge outliers, see appendix

final_price = lm(Price ~ Priming*Product+ Behav_enviro + Age,  data = base_price)

apa_lm <- apa_print(anova(final_price))
apa_table(apa_lm$table,  caption = "Anova table for Price.")
```
```{r, results="hide"}

plot_model(final_price)

sjPlot::plot_model(final_price, type = "pred")[3]

```

$~$
$~$

#### Probability to buy
```{r lm Buy}
base_buy = filter(base_clean, id %notin% c("13804")) #remove huge outliers, see appendix


final_buy = lm(Buy ~ Priming*Product + Behav_enviro + Age,  data = base_buy)

apa_lm <- apa_print(anova(final_buy))
apa_table(apa_lm$table,  caption = "Anova table for Probability to buy.")

````
```{r, results="hide"}
sjPlot::plot_model(final_buy)


sjPlot::plot_model(final_buy, type = "pred")[2]
sjPlot::plot_model(final_buy, type = "pred")[3]
sjPlot::plot_model(final_buy, type = "pred")[4]

```

$~$
$~$

#### Reccomendation
```{r lm Recco}
base_recco = base_clean #no huge outliers, see appendix

final_recco = lm(Reccomend ~ Priming*Product+Product*Behav_enviro + Age + Gender,  data = base_recco)

apa_lm <- apa_print(anova(final_recco))
apa_table(apa_lm$table,  caption = "Anova table for Reccomendation.")
```

```{r, results="hide"}
sjPlot::plot_model(final_recco)

sjPlot::plot_model(final_recco, type = "pred")[2]
sjPlot::plot_model(final_recco, type = "pred")[3]

interactions::interact_plot(final_recco, pred = Behav_enviro, modx = Product, interval = TRUE)


```
\
Example for reporting :\

Product (`r apa_lm$full_result$Product`) and Behav_enviro (`r apa_lm$full_result$Behav_enviro`) affected reccomendation. However, the effect of Behav_enviro differed by Product, `r apa_lm$full_result$Product_Behav_enviro`.

$~$
$~$
  
#### Ecologic Evaluation
  
  
```{r lm Ecolo_Eval}

base_eco = filter(base_clean, id %notin% c("13594", "11200", "13804", "12529", "11017")) #remove huge outliers, see appendix

final_eco = lm(Ecolo_Eval ~ Priming*Product+Behav_enviro + Age + Gender,  data = base_eco)

apa_lm <- apa_print(anova(final_eco))
apa_table(apa_lm$table, caption = "Anova table for Reccomendation.")
```

```{r, results="hide"}
sjPlot::plot_model(final_eco)

sjPlot::plot_model(final_eco, type = "pred")[2]
sjPlot::plot_model(final_eco, type = "pred")[3]

```

$~$
$~$
  
### Appendix
  
$~$
$~$
  
#### Visual check normality
  
```{r annexes, fig.show="hold", out.width="50%"}

plotNormalHistogram(base_clean$Price, main = "Price", sub = paste("skewness =", skewness(base_clean$Price, na.rm = TRUE))) 


# print("Check price density by product")
# densityPlot(base_clean$Price, g = base_clean$Product) # by product

plotNormalHistogram(base_clean$Reccomend, main = "Reccomendation", sub = paste("skewness =", round(skewness(base_clean$Reccomend, na.rm = TRUE)),2))



plotNormalHistogram(base_clean$Buy, main = "Probability to buy", sub = 
                      paste("skewness =", round(skewness(base_clean$Buy, na.rm = TRUE),2)))


plotNormalHistogram(base_clean$Ecolo_Eval, main = "Ecologic Evaluation", sub =
                      paste("skewness =", round(skewness(base_clean$Ecolo_Eval, na.rm = TRUE),2)))

```

$~$
$~$
  
  
#### Model selection for price
```{r diag lm MSprice, echo=FALSE, message=FALSE, warning=FALSE}
modprice = lm(Price ~ Priming*Product*Behav_enviro + Priming*Product*Decision_mode + Priming*Product*Age, data = base_clean)

MS = MASS::stepAIC(modprice, direction = "both", trace = FALSE)

x = kable(attributes(MS$anova)$heading, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(1, bold=T,align='c') 
gsub("<thead>.*</thead>", "", x)


kable(MS$anova, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0, bold=T,align='c')

```

$~$
$~$
  
#### Price: Diagnostics Plots for linear model 
  
```{r diag lm Price2, echo=FALSE, results='hide',  fig.show="hold", out.width="50%"}
modprice = lm(Price ~ Priming + Product + Behav_enviro + Age + Priming:Product, data = base_price)

plot(modprice, c(1:2,4), labels.id = base_price$id)
sjPlot::plot_model(modprice, type="diag")[[3]]
```

$~$
$~$

#### Model selection for Probality to buy
```{r diag lm MSbuy, echo=FALSE, message=FALSE, warning=FALSE}

modbuy = lm(Buy ~ Priming*Product*Behav_enviro + Priming*Product*Decision_mode + Priming*Product*Age, data = base_clean)

MS = MASS::stepAIC(modbuy, direction = "both", trace = FALSE)

x = kable(attributes(MS$anova)$heading, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(1, bold=T,align='c') 
gsub("<thead>.*</thead>", "", x)


kable(MS$anova, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0, bold=T,align='c')

```

$~$
$~$
  
  
#### Probability to buy: Diagnostics Plots for linear model  
```{r diag lm Buy2, echo=FALSE, results="hide", fig.show="hold", out.width="50%"}
modbuy = lm(Buy ~ Product*Priming + Behav_enviro + Age + Product:Behav_enviro, data = base_buy)

plot(modbuy, c(1:2,4), labels.id = base_buy$id)
sjPlot::plot_model(modbuy, type="diag")[[3]]
```

$~$
$~$
  
#### Model selection for Reccomendation
```{r diag lm MSrecco, echo=FALSE, message=FALSE, warning=FALSE}

modrecco = lm(Reccomend ~ Priming*Product*Behav_enviro + Priming*Product*Decision_mode + Priming*Product*Age, data = base_clean)

MS = MASS::stepAIC(modrecco, direction = "both", trace = FALSE)

x = kable(attributes(MS$anova)$heading, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(1, bold=T,align='c') 
gsub("<thead>.*</thead>", "", x)


kable(MS$anova, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0, bold=T,align='c')

```


$~$
$~$
  
#### Reccomendation: Diagnostics Plots for linear model AFTER
```{r diag lm Recco2, echo=FALSE, results="hide", fig.show="hold", out.width="50%"}
modrecco = lm(Reccomend ~ Priming*Product + Behav_enviro + Product:Behav_enviro, data = base_recco)

plot(modrecco, c(1:2,4), labels.id = base_recco$id)
sjPlot::plot_model(modrecco, type="diag")[[3]]
```

$~$
$~$
  

#### Model selection for Ecologic Evaluation
```{r diag lm MSeco, echo=FALSE, message=FALSE, warning=FALSE}
modeco = lm(Ecolo_Eval ~ Priming*Product*Behav_enviro + Priming*Product*Decision_mode + Priming*Product*Age, data = base_clean)

MS = MASS::stepAIC(modeco, direction = "both", trace = FALSE)

x = kable(attributes(MS$anova)$heading, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(1, bold=T,align='c') 
gsub("<thead>.*</thead>", "", x)


kable(MS$anova, format="html") %>%
    kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0, bold=T,align='c')

```

$~$
$~$
  
#### Ecologic Evaluation: Diagnostics Plots for linear model AFTER
```{r diag lm EcoEval, echo=FALSE, results="hide", fig.show="hold", out.width="50%"}
modeco = lm(Ecolo_Eval ~ Priming*Product*Decision_mode + Behav_enviro + Priming*Product*Age, data = base_eco)

plot(modeco, c(1:2,4), labels.id = base_eco$id)
sjPlot::plot_model(modeco, type="diag")[[3]]
```

$~$
$~$
  


```{r}
report::report_packages()
```

